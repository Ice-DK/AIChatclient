application:
  applicationName: convex-backend

  # External secrets til sensitive data
  externalSecret:
    enabled: true
    files:
      secrets:
        data:
          instance-secret:
            remoteRef:
              key: k8s/prod21/dev-pewa/unrestricted/convex-backend
              property: instance-secret
          azure-foundry-endpoint:
            remoteRef:
              key: k8s/prod21/dev-pewa/unrestricted/convex-backend
              property: azure-foundry-endpoint
          azure-foundry-api-key:
            remoteRef:
              key: k8s/prod21/dev-pewa/unrestricted/convex-backend
              property: azure-foundry-api-key
          atlassian-client-id:
            remoteRef:
              key: k8s/prod21/dev-pewa/unrestricted/convex-backend
              property: atlassian-client-id
          atlassian-client-secret:
            remoteRef:
              key: k8s/prod21/dev-pewa/unrestricted/convex-backend
              property: atlassian-client-secret

  deployment:
    strategy:
      type: Recreate
    enabled: true
    replicas: 1
    image:
      repository: registry.netic.dk/cloudfactory/convex-backend
      tag: "1.0.2"
    ports:
      - containerPort: 3210
        name: http
      - containerPort: 3211
        name: site-proxy
    env:
      # Convex origins - opdater til din faktiske URL
      CONVEX_CLOUD_ORIGIN:
        value: "https://convex.chaosbot.cfcore.dk"
      CONVEX_SITE_ORIGIN:
        value: "http://convex-site.chaosbot.cfcore.dk"
      # Instance config
      INSTANCE_NAME:
        value: "ai-chatclient"
      INSTANCE_SECRET:
        valueFrom:
          secretKeyRef:
            name: convex-backend-secrets
            key: instance-secret
      # Database (SQLite som default, kan Ã¦ndres til Postgres)
      # DATABASE_URL:
      #   value: "postgres://user:pass@host:5432/convex"
      # Logging
      RUST_LOG:
        value: "info"
      # Document retention (2 dage)
      DOCUMENT_RETENTION_DELAY:
        value: "172800"
      # Disable SSL requirement for internal traffic
      DO_NOT_REQUIRE_SSL:
        value: "true"
      # Azure AI Foundry (til AI actions)
      AZURE_FOUNDRY_ENDPOINT:
        valueFrom:
          secretKeyRef:
            name: convex-backend-secrets
            key: azure-foundry-endpoint
      AZURE_FOUNDRY_API_KEY:
        valueFrom:
          secretKeyRef:
            name: convex-backend-secrets
            key: azure-foundry-api-key
      AZURE_FOUNDRY_DEPLOYMENT:
        value: "gpt-5.2"
      # Atlassian OAuth
      ATLASSIAN_CLIENT_ID:
        valueFrom:
          secretKeyRef:
            name: convex-backend-secrets
            key: atlassian-client-id
      ATLASSIAN_CLIENT_SECRET:
        valueFrom:
          secretKeyRef:
            name: convex-backend-secrets
            key: atlassian-client-secret
    resources:
      limits:
        memory: 2Gi
      requests:
        cpu: 200m
        memory: 512Mi
    livenessProbe:
      httpGet:
        path: /version
        port: http
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 10
    readinessProbe:
      httpGet:
        path: /version
        port: http
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
    # Persistent storage for Convex data
    volumeMounts:
      convex-data:
        mountPath: /convex/data
    volumes:
      convex-data:
        persistentVolumeClaim:
          claimName: convex-backend-data
  service:
    enabled: true
    ports:
      - port: 8080
        name: http
        protocol: TCP
        targetPort: http
      - port: 3211
        name: site-proxy
        protocol: TCP
        targetPort: site-proxy
  httpProxy:
    enabled: true
    rootProxy:
      fqdn: convex.chaosbot.cfcore.dk
      pathPrefix: /
